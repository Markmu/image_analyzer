# Story 0-2: 数据库配置

Status: done

## Story

As a 开发团队,
I want 配置 PostgreSQL 数据库和 Drizzle ORM 基础配置,
so that 我们可以在具体业务模块时按需添加数据库 Schema.

## User Outcomes

- 应用可以连接到 PostgreSQL 数据库
- Drizzle ORM 基础配置完成
- 数据库迁移系统可用
- 开发者可以运行本地数据库实例

## Important Notes

**数据库 Schema 定义已延迟到业务模块实现时添加**，详见 Sprint Change Proposal。

## Acceptance Criteria

1. [x] PostgreSQL 数据库配置正确:
   - [x] 使用 PostgreSQL Latest Stable 或 Docker 本地实例
   - [x] 数据库连接字符串配置在 .env.local
2. [x] Drizzle ORM 配置正确:
   - [x] drizzle.config.ts 配置正确
   - [x] src/lib/db/index.ts 连接实例配置完成
   - [x] 连接池配置合理（开发环境）
3. [x] 数据库迁移系统可用:
   - [x] 可以生成迁移文件 (npm run db:generate)
   - [x] 可以运行迁移 (npm run db:migrate)
   - [x] 可以回滚迁移 (npm run db:rollback)
4. [x] Docker 本地开发环境（如使用）:
   - [x] docker-compose.yml 配置 PostgreSQL
   - [x] 可以启动/停止本地数据库

## Tasks / Subtasks

- [x] Task 1: 安装数据库依赖 (AC: #1, #2)
  - [x] 1.1 安装 drizzle-orm
  - [x] 1.2 安装 postgres 驱动（或 @vercel/postgres）
  - [x] 1.3 安装 drizzle-kit（迁移工具）
- [x] Task 2: 配置 Drizzle 连接 (AC: #2)
  - [x] 2.1 创建 src/lib/db/index.ts
  - [x] 2.2 配置 drizzle.config.ts
  - [x] 2.3 配置环境变量 DATABASE_URL
  - [x] 2.4 创建 src/lib/db/schema.ts（空文件）
- [x] Task 3: 设置迁移系统 (AC: #3)
  - [x] 3.1 配置迁移目录 drizzle/
  - [x] 3.2 创建迁移生成脚本 (npm run db:generate)
  - [x] 3.3 创建迁移运行脚本 (npm run db:migrate)
  - [x] 3.4 创建回滚脚本 (npm run db:rollback)
- [x] Task 4: Docker 本地开发环境（如使用）(AC: #4)
  - [x] 4.1 创建 docker-compose.yml
  - [x] 4.2 配置 PostgreSQL 服务
  - [x] 4.3 添加 pgAdmin（如需要）

## Dev Notes

### 依赖安装

```bash
npm install drizzle-orm
npm install -D drizzle-kit
```

### Drizzle 配置示例

```typescript
// src/lib/db/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

const client = postgres(process.env.DATABASE_URL!, {
  max: 10,
  idle_timeout: 30,
  connect_timeout: 2,
});

export const db = drizzle(client, { schema });

export { schema };
```

```typescript
// drizzle.config.ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/lib/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

### 数据库 Schema 延迟说明

根据 Sprint Change Proposal，**数据库 Schema 定义在具体业务模块实现时添加**：

| Epic | 模块 | Schema 文件 |
|------|------|------------|
| Epic 1 | 用户认证 | `users.ts`, `accounts.ts`, `sessions.ts` |
| Epic 2 | 图片上传 | `images.ts` |
| Epic 3 | AI 分析 | `analysis_results.ts` |
| Epic 5 | 模版生成 | `templates.ts` |
| Epic 6 | 图片生成 | `generations.ts` |
| Epic 7 | 历史记录 | 扩展 templates 表 |
| Epic 8 | 订阅支付 | `credits.ts`, `subscriptions.ts`, `credit_transactions.ts` |

当前 Story 仅需创建基础结构：

```
src/lib/db/
├── index.ts           # Drizzle 实例和连接
├── schema.ts          # 空文件（未来导出业务 Schema）
└── migrations/        # 迁移文件目录
```

### 环境变量

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/image_analyzer?schema=public"
```

### 迁移命令

```bash
# 生成迁移
npx drizzle-kit generate

# 运行迁移
npx drizzle-kit push

# 或使用 migrate 命令
npx drizzle-kit migrate

# 打开 Studio
npx drizzle-kit studio
```

### 命名规范

| 类别     | 规则            | 示例                     |
| -------- | --------------- | ------------------------ |
| 数据库表 | snake_case 复数 | `users`, `templates`     |
| 数据库列 | snake_case      | `created_at`, `user_id` |
| 外键列   | snake_case      | `user_id`, `template_id` |

### Project Structure Notes

```
src/lib/db/
├── index.ts           # Drizzle 实例和连接
├── schema.ts          # 空文件，业务 Schema 延迟到 Epic 1-8
└── migrations/        # 迁移文件目录
```

### Docker 开发环境（如使用）

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: image_analyzer_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: image_analyzer
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

## References

- 数据库设计: [architecture.md#data-architecture](_bmad-output/planning-artifacts/architecture.md#data-architecture)
- 项目结构: [architecture.md#project-structure](_bmad-output/planning-artifacts/architecture.md#project-structure)
- 命名规范: [architecture.md#naming-patterns](_bmad-output/planning-artifacts/architecture.md#naming-patterns)
- Sprint Change Proposal: [sprint-change-proposal-2026-02-03.md](_bmad-output/implementation-artifacts/sprint-change-proposal-2026-02-03.md)

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

- 2026-02-03: 完成所有数据库配置工作
  - 安装并配置 drizzle-orm + postgres 驱动
  - 创建 Drizzle 连接实例 (src/lib/db/index.ts)
  - 配置 drizzle.config.ts
  - 创建空 schema.ts 文件（业务 Schema 延迟到 Epic 1-8）
  - 添加数据库迁移脚本 (db:generate, db:migrate, db:push, db:studio, db:rollback)
  - 配置 Docker PostgreSQL 环境 (docker-compose.yml)
  - 修复 TypeScript 类型错误
  - 验证 TypeScript 编译通过

- 2026-02-03: 代码审查修复
  - H-1: 添加数据库连接错误处理和环境变量验证
  - H-2: 添加连接池管理和优雅关闭机制 (closeDbConnection)
  - H-3: 添加数据库连接测试 (src/lib/db/db.test.ts)
  - M-1: 创建 drizzle/README.md 文档
  - M-2: 移除重复的 pg 依赖（保留 postgres）
  - L-1: 添加 DATABASE_URL 环境变量启动时验证
  - 安装 vitest 测试框架
  - 验证 TypeScript 编译通过
  - 验证 ESLint 通过

### File List

**已完成的文件：**
- `drizzle.config.ts` - Drizzle ORM 配置文件
- `src/lib/db/index.ts` - Drizzle 连接实例和配置（含错误处理）
- `src/lib/db/schema.ts` - 空 Schema 文件（业务 Schema 延迟到各 Epic）
- `src/lib/db/db.test.ts` - 数据库连接测试文件
- `docker-compose.yml` - Docker PostgreSQL 本地开发环境
- `.env.local` - 环境变量配置（DATABASE_URL）
- `drizzle/README.md` - 迁移命令说明文档
- `package.json` - 添加了 db:* 脚本

**新增/修改的依赖：**
- `postgres` - PostgreSQL 连接库
- `@types/pg` - pg 类型声明
- `vitest` - 测试框架
