# Story 0-2: 数据库配置

Status: ready-for-dev

## Story

As a 开发团队,
I want 配置 PostgreSQL 数据库和 Drizzle ORM,
so that 我们可以安全地存储和管理应用数据.

## User Outcomes

- 应用可以连接到 PostgreSQL 数据库
- 数据库 Schema 定义符合架构规范
- 数据库迁移可以正常运行
- 开发者可以运行本地数据库实例

## Acceptance Criteria

1. [ ] PostgreSQL 数据库配置正确:
   - [ ] 使用 PostgreSQL Latest Stable
   - [ ] 数据库连接字符串配置在 .env.local
2. [ ] Drizzle ORM 配置正确:
   - [ ] drizzle.config.ts 配置正确
   - [ ] 连接池配置合理
3. [ ] 数据库 Schema 定义完整:
   - [ ] users 表（含 OAuth ID, email, created_at 等）
   - [ ] accounts 表（NextAuth 账户关联）
   - [ ] sessions 表（会话存储）
   - [ ] verification_tokens 表（验证令牌）
   - [ ] templates 表（用户模版）
   - [ ] analysis_results 表（分析结果）
   - [ ] generated_images 表（生成的图片）
   - [ ] credits_transactions 表（Credit 交易记录）
4. [ ] 数据库关系正确:
   - [ ] users 与其他表的外键关系
   - [ ] templates 与 users 的关系
   - [ ] analysis_results 与 users, templates 的关系
5. [ ] 数据库迁移系统正常:
   - [ ] 可以生成迁移文件
   - [ ] 可以运行迁移
   - [ ] 可以回滚迁移
6. [ ] 数据库种子数据（如需要）:
   - [ ] 种子脚本可以运行

## Tasks / Subtasks

- [ ] Task 1: 安装数据库依赖 (AC: #1, #2)
  - [ ] 1.1 安装 drizzle-orm
  - [ ] 1.2 安装 postgres 驱动（或 @vercel/postgres）
  - [ ] 1.3 安装 drizzle-kit（迁移工具）
- [ ] Task 2: 配置 Drizzle 连接 (AC: #2)
  - [ ] 2.1 创建 src/lib/db/index.ts
  - [ ] 2.2 配置 drizzle.config.ts
  - [ ] 2.3 配置环境变量 DATABASE_URL
- [ ] Task 3: 定义数据库 Schema (AC: #3)
  - [ ] 3.1 创建 src/lib/db/schema/users.ts
  - [ ] 3.2 创建 src/lib/db/schema/accounts.ts
  - [ ] 3.3 创建 src/lib/db/schema/sessions.ts
  - [ ] 3.4 创建 src/lib/db/schema/verification_tokens.ts
  - [ ] 3.5 创建 src/lib/db/schema/templates.ts
  - [ ] 3.6 创建 src/lib/db/schema/analysis_results.ts
  - [ ] 3.7 创建 src/lib/db/schema/generated_images.ts
  - [ ] 3.8 创建 src/lib/db/schema/credits_transactions.ts
  - [ ] 3.9 创建 src/lib/db/schema/index.ts（导出所有表）
- [ ] Task 4: 设置表关系 (AC: #4)
  - [ ] 4.1 配置外键关系
  - [ ] 4.2 配置级联删除规则
- [ ] Task 5: 配置迁移系统 (AC: #5)
  - [ ] 5.1 配置迁移目录
  - [ ] 5.2 创建迁移生成脚本
  - [ ] 5.3 创建迁移运行脚本
  - [ ] 5.4 创建回滚脚本
- [ ] Task 6: 创建种子数据 (AC: #6)
  - [ ] 6.1 创建 seed.ts
  - [ ] 6.2 添加必要的初始数据

## Dev Notes

### 依赖安装

```bash
npm install drizzle-orm
npm install -D drizzle-kit
```

### 数据库 Schema 设计原则

- **表名**: snake_case 复数形式（`users`, `templates`, `analysis_results`）
- **列名**: snake_case（`created_at`, `user_id`, `credit_balance`）
- **主键**: 使用 `id` UUID 或 `ulid`
- **时间戳**: 使用 `created_at` 和 `updated_at`
- **软删除**: 使用 `deleted_at`（如果需要）

### 核心 Schema 示例

```typescript
// users.ts
export const users = pgTable('users', {
  id: text('id').primaryKey(),
  name: text('name'),
  email: text('email').notNull().unique(),
  emailVerified: timestamp('email_verified'),
  image: text('image'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// 关联 NextAuth
export const accounts = pgTable(
  'accounts',
  {
    userId: text('user_id')
      .references(() => users.id, { onDelete: 'cascade' })
      .notNull(),
    type: text('type').notNull(),
    provider: text('provider').notNull(),
    providerAccountId: text('provider_account_id').notNull(),
    refresh_token: text('refresh_token'),
    access_token: text('access_token'),
    expires_at: integer('expires_at'),
    token_type: text('token_type'),
    scope: text('scope'),
    id_token: text('id_token'),
    session_state: text('session_state'),
  },
  (account) => ({
    compoundKey: primaryKey({ columns: [account.provider, account.providerAccountId] }),
  }),
);

// templates.ts
export const templates = pgTable('templates', {
  id: text('id').primaryKey(),
  userId: text('user_id')
    .references(() => users.id, { onDelete: 'cascade' })
    .notNull(),
  name: text('name').notNull(),
  content: text('content').notNull(),
  jsonContent: jsonb('json_content'),
  styleFeatures: jsonb('style_features'),
  isPublic: boolean('is_public').default(false),
  isFavorite: boolean('is_favorite').default(false),
  usageCount: integer('usage_count').default(0),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

### 环境变量

```env
DATABASE_URL="postgresql://user:password@localhost:5432/image_analyzer?schema=public"
```

### 迁移命令

```bash
# 生成迁移
npx drizzle-kit generate

# 运行迁移
npx drizzle-kit push

# 或使用 migrate 命令
npx drizzle-kit migrate

# 打开 Studio
npx drizzle-kit studio
```

### 命名规范

| 类别     | 规则            | 示例                     |
| -------- | --------------- | ------------------------ |
| 数据库表 | snake_case 复数 | `users`, `templates`     |
| 数据库列 | snake_case      | `created_at`, `user_id`  |
| 外键列   | snake_case      | `user_id`, `template_id` |

### Project Structure Notes

```
src/lib/db/
├── index.ts           # Drizzle 实例和连接
├── schema.ts          # 导出所有表（简化版）
├── schema/
│   ├── index.ts      # 导出所有 schema
│   ├── users.ts       # 用户表
│   ├── accounts.ts    # NextAuth 账户
│   ├── sessions.ts    # 会话表
│   ├── templates.ts   # 模版表
│   ├── analysis_results.ts  # 分析结果表
│   ├── generated_images.ts  # 生成图片表
│   └── credits_transactions.ts  # Credit 交易表
└── migrations/        # 迁移文件目录
```

### References

- 数据库设计: [architecture.md#data-architecture](_bmad-output/planning-artifacts/architecture.md#data-architecture)
- 项目结构: [architecture.md#project-structure](_bmad-output/planning-artifacts/architecture.md#project-structure)
- 命名规范: [architecture.md#naming-patterns](_bmad-output/planning-artifacts/architecture.md#naming-patterns)

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

### File List

- `drizzle.config.ts`
- `src/lib/db/index.ts`
- `src/lib/db/schema.ts`
- `src/lib/db/schema/users.ts`
- `src/lib/db/schema/accounts.ts`
- `src/lib/db/schema/sessions.ts`
- `src/lib/db/schema/verification_tokens.ts`
- `src/lib/db/schema/templates.ts`
- `src/lib/db/schema/analysis_results.ts`
- `src/lib/db/schema/generated_images.ts`
- `src/lib/db/schema/credits_transactions.ts`
