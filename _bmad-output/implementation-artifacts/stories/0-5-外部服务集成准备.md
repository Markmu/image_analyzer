# Story 0-5: 外部服务集成准备

Status: done

## Story

As a 开发团队,
I want 配置所有外部服务的集成基础结构,
so that 我们可以在后续功能开发中无缝调用这些服务.

## User Outcomes

- NextAuth.js Google OAuth 配置就绪
- Replicate API 客户端可使用
- Cloudflare R2 存储客户端可使用
- Creem 支付集成准备就绪
- 所有 API 密钥正确配置在环境变量中

## Acceptance Criteria

1. [x] NextAuth.js 配置正确:
   - [x] src/lib/auth/index.ts 配置正确
   - [x] src/lib/auth/options.ts 配置 Google OAuth
   - [x] 使用 Drizzle Adapter 连接数据库
   - [x] JWT 会话配置正确
2. [x] Replicate API 客户端配置正确:
   - [x] src/lib/replicate/index.ts 客户端初始化
   - [x] src/lib/replicate/vision.ts 视觉模型封装
   - [x] src/lib/replicate/text.ts 文字模型封装
   - [x] src/lib/replicate/image.ts 生图模型封装
3. [x] Cloudflare R2 存储客户端配置正确:
   - [x] src/lib/r2/index.ts 客户端初始化
   - [x] src/lib/r2/upload.ts 上传函数
   - [x] src/lib/r2/download.ts 下载函数
4. [x] Creem 支付集成配置正确:
   - [x] src/lib/creem/index.ts 客户端初始化
   - [x] src/lib/creem/checkout.ts Checkout API
   - [x] src/lib/creem/webhook.ts Webhook 处理
5. [x] 环境变量模板正确:
   - [x] .env.example 包含所有必需变量
   - [x] .env.local 示例值占位
6. [x] API 响应格式统一:
   - [x] 所有服务遵循 ApiResponse 格式
   - [x] 错误处理统一
7. [x] 类型定义完整:
   - [x] 各服务的 TypeScript 类型定义

## Tasks / Subtasks

- [x] Task 1: 配置 NextAuth.js (AC: #1)
  - [x] 1.1 安装 next-auth @auth/drizzle-adapter
  - [x] 1.2 创建 src/lib/auth/index.ts
  - [x] 1.3 创建 src/lib/auth/options.ts
  - [x] 1.4 配置 Drizzle Adapter
  - [x] 1.5 配置 JWT 会话
- [x] Task 2: 配置 Replicate API 客户端 (AC: #2)
  - [x] 2.1 安装 replicate SDK
  - [x] 2.2 创建 src/lib/replicate/index.ts
  - [x] 2.3 创建 src/lib/replicate/vision.ts
  - [x] 2.4 创建 src/lib/replicate/text.ts
  - [x] 2.5 创建 src/lib/replicate/image.ts
- [x] Task 3: 配置 R2 存储客户端 (AC: #3)
  - [x] 3.1 安装 @aws-sdk/client-s3 @aws-sdk/lib-storage
  - [x] 3.2 创建 src/lib/r2/index.ts
  - [x] 3.3 创建 src/lib/r2/upload.ts
  - [x] 3.4 创建 src/lib/r2/download.ts
- [x] Task 4: 配置 Creem 支付集成 (AC: #4)
  - [x] 4.1 安装 creem-sdk 或使用 REST API
  - [x] 4.2 创建 src/lib/creem/index.ts
  - [x] 4.3 创建 src/lib/creem/checkout.ts
  - [x] 4.4 创建 src/lib/creem/webhook.ts
- [x] Task 5: 创建环境变量模板 (AC: #5)
  - [x] 5.1 创建 .env.example
  - [x] 5.2 添加所有必需的环境变量
  - [x] 5.3 添加变量说明注释
- [x] Task 6: 统一 API 响应格式 (AC: #6, #7)
  - [x] 6.1 创建统一错误处理
  - [x] 6.2 创建类型定义

## Dev Notes

### NextAuth.js 配置

```typescript
// src/lib/auth/index.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import { DrizzleAdapter } from '@auth/drizzle-adapter';
import { db } from '@/lib/db';

export const authOptions = {
  adapter: DrizzleAdapter(db),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],
  session: {
    strategy: 'jwt',
  },
  callbacks: {
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.sub!;
      }
      return session;
    },
  },
};

export const { handlers, auth, signIn, signOut } = NextAuth(authOptions);
```

### Replicate API 客户端

```typescript
// src/lib/replicate/index.ts
import Replicate from 'replicate';

export const replicate = new Replicate({
  auth: process.env.REPLICATE_API_TOKEN!,
});

// src/lib/replicate/vision.ts
export async function analyzeImage(imageUrl: string) {
  const output = await replicate.run('your-vision-model', {
    input: { image: imageUrl },
  });
  return output;
}
```

### R2 存储客户端

```typescript
// src/lib/r2/index.ts
import { S3Client } from '@aws-sdk/client-s3';
import { Upload } from '@aws-sdk/lib-storage';
import { PassThrough } from 'stream';

export const r2 = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
  },
});

export async function uploadToR2(key: string, body: Buffer | ReadableStream): Promise<string> {
  // 上传实现
  return key;
}
```

### Creem 支付集成

```typescript
// src/lib/creem/index.ts
export const CREEM_API_URL = 'https://api.creem.io';

export async function createCheckoutSession(productId: string, userId: string) {
  const response = await fetch(`${CREEM_API_URL}/checkout`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${process.env.CREEM_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ productId, userId }),
  });
  return response.json();
}
```

### 环境变量模板

```env
# NextAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=http://localhost:3000

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/image_analyzer

# Replicate
REPLICATE_API_TOKEN=your_replicate_api_token

# Cloudflare R2
R2_ACCOUNT_ID=your_account_id
R2_ACCESS_KEY_ID=your_access_key_id
R2_SECRET_ACCESS_KEY=your_secret_access_key
R2_BUCKET_NAME=image-analyzer

# Creem
CREEM_API_KEY=your_creem_api_key
CREEM_WEBHOOK_SECRET=your_webhook_secret
```

### 命名规范

| 类别     | 规则             | 示例                       |
| -------- | ---------------- | -------------------------- |
| 服务模块 | kebab-case       | `replicate`, `r2`, `creem` |
| 服务文件 | kebab-case       | `vision.ts`, `checkout.ts` |
| 环境变量 | UPPER_SNAKE_CASE | `REPLICATE_API_TOKEN`      |

### Project Structure Notes

```
src/lib/
├── auth/
│   ├── index.ts       # NextAuth 导出
│   └── options.ts      # Auth 选项
├── replicate/
│   ├── index.ts       # Replicate 客户端
│   ├── vision.ts      # 视觉模型
│   ├── text.ts        # 文字模型
│   └── image.ts       # 生图模型
├── r2/
│   ├── index.ts       # R2 客户端
│   ├── upload.ts      # 上传函数
│   └── download.ts    # 下载函数
└── creem/
    ├── index.ts       # Creem 客户端
    ├── checkout.ts    # Checkout API
    └── webhook.ts    # Webhook 处理
```

### References

- 技术栈: [architecture.md#core-architectural-decisions](_bmad-output/planning-artifacts/architecture.md#core-architectural-decisions)
- API 格式: [architecture.md#format-patterns](_bmad-output/planning-artifacts/architecture.md#format-patterns)
- 集成点: [architecture.md#integration-points](_bmad-output/planning-artifacts/architecture.md#integration-points)

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

- 2026-02-04: 完成 NextAuth.js 认证模块配置。创建了 auth/ 目录，包含 index.ts（NextAuth 导出）和 options.ts（认证配置）。配置了 Google OAuth 登录、Drizzle Adapter 数据库集成、JWT 会话策略。
- 2026-02-04: 完成 Replicate API 客户端配置。创建了 replicate/ 目录，包含 index.ts（Replicate 客户端初始化）、vision.ts（图像分析）、text.ts（文本生成）、image.ts（图像生成）。
- 2026-02-04: 完成 R2 存储客户端配置。创建了 r2/ 目录，包含 index.ts（S3 客户端初始化）、upload.ts（上传函数）、download.ts（下载函数）。支持 Buffer、Stream、文本、JSON 上传和下载。
- 2026-02-04: 完成 Creem 支付集成配置。创建了 creem/ 目录，包含 index.ts（API 客户端）、checkout.ts（结账 API）、webhook.ts（Webhook 处理）。支持签名验证和多种事件处理。
- 2026-02-04: 完成环境变量模板配置。创建了 .env.example 文件，包含所有必需的环境变量和详细注释。
- 2026-02-04: 完成统一 API 响应格式配置。创建了 api/ 目录，包含 types.ts（类型定义）、errors.ts（错误处理）。提供 ApiResponse 包装器和常用错误类。

### File List

**New Files:**
- `src/lib/auth/index.ts` - NextAuth 导出模块
- `src/lib/auth/options.ts` - 认证配置选项
- `src/__tests__/lib/auth/auth.test.ts` - NextAuth 测试文件
- `src/lib/replicate/index.ts` - Replicate 客户端
- `src/lib/replicate/vision.ts` - 视觉模型封装
- `src/lib/replicate/text.ts` - 文本模型封装
- `src/lib/replicate/image.ts` - 图像生成封装
- `src/__tests__/lib/replicate/replicate.test.ts` - Replicate 测试文件
- `src/lib/r2/index.ts` - R2 存储客户端
- `src/lib/r2/upload.ts` - 上传函数
- `src/lib/r2/download.ts` - 下载函数
- `src/__tests__/lib/r2/r2.test.ts` - R2 存储测试文件
- `src/lib/creem/index.ts` - Creem 客户端
- `src/lib/creem/checkout.ts` - 结账 API
- `src/lib/creem/webhook.ts` - Webhook 处理
- `src/__tests__/lib/creem/creem.test.ts` - Creem 测试文件
- `src/lib/api/types.ts` - API 响应类型
- `src/lib/api/errors.ts` - 错误处理
- `src/lib/api/index.ts` - API 模块导出
- `src/__tests__/lib/api/api.test.ts` - API 测试文件
- `.env.example` - 环境变量模板

## Senior Developer Review (AI)

### Review Performed
- **Reviewer**: Claude Code (Adversarial Code Review)
- **Date**: 2026-02-04
- **Type**: Full Implementation Review

### Issues Found & Fixed
1. **HIGH**: TypeScript 编译错误 (r2/download.ts, r2/upload.ts, replicate/*.ts)
   - 修复: 添加缺失的导入、修复类型断言、添加响应类型接口

2. **HIGH**: 缺失的环境变量验证 (replicate/index.ts)
   - 修复: 添加 REPLICATE_API_TOKEN 验证

3. **HIGH**: Creem API Key 缺失验证
   - 修复: 添加 CREEM_API_KEY 验证

4. **MEDIUM**: 测试质量改进 (auth.test.ts)
   - 修复: 添加 handlers/auth/signIn/signOut 导出测试

5. **MEDIUM**: api/index.ts 导出不完整
   - 修复: 添加 response.ts 导出

6. **MEDIUM**: r2/index.ts 类型问题
   - 修复: 添加运行时验证

### Test Results
- **Tests Run**: 61
- **Passed**: 60
- **Failed**: 1 (数据库连接测试，预期失败 - 无数据库环境)
- **TypeScript**: Clean

### Verification
- [x] All ACs implemented
- [x] All tasks marked [x] are actually done
- [x] TypeScript compilation passes
- [x] Tests pass (except expected db connection failure)
- [x] Security review passed
- [x] Performance review passed

**Review Status**: APPROVED ✓
