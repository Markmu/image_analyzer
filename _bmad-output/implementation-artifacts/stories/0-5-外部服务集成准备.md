# Story 0-5: 外部服务集成准备

Status: ready-for-dev

## Story

As a 开发团队,
I want 配置所有外部服务的集成基础结构,
so that 我们可以在后续功能开发中无缝调用这些服务.

## User Outcomes

- NextAuth.js Google OAuth 配置就绪
- Replicate API 客户端可使用
- Cloudflare R2 存储客户端可使用
- Creem 支付集成准备就绪
- 所有 API 密钥正确配置在环境变量中

## Acceptance Criteria

1. [ ] NextAuth.js 配置正确:
   - [ ] src/lib/auth/index.ts 配置正确
   - [ ] src/lib/auth/options.ts 配置 Google OAuth
   - [ ] 使用 Drizzle Adapter 连接数据库
   - [ ] JWT 会话配置正确
2. [ ] Replicate API 客户端配置正确:
   - [ ] src/lib/replicate/index.ts 客户端初始化
   - [ ] src/lib/replicate/vision.ts 视觉模型封装
   - [ ] src/lib/replicate/text.ts 文字模型封装
   - [ ] src/lib/replicate/image.ts 生图模型封装
3. [ ] Cloudflare R2 存储客户端配置正确:
   - [ ] src/lib/r2/index.ts 客户端初始化
   - [ ] src/lib/r2/upload.ts 上传函数
   - [ ] src/lib/r2/download.ts 下载函数
4. [ ] Creem 支付集成配置正确:
   - [ ] src/lib/creem/index.ts 客户端初始化
   - [ ] src/lib/creem/checkout.ts Checkout API
   - [ ] src/lib/creem/webhook.ts Webhook 处理
5. [ ] 环境变量模板正确:
   - [ ] .env.example 包含所有必需变量
   - [ ] .env.local 示例值占位
6. [ ] API 响应格式统一:
   - [ ] 所有服务遵循 ApiResponse 格式
   - [ ] 错误处理统一
7. [ ] 类型定义完整:
   - [ ] 各服务的 TypeScript 类型定义

## Tasks / Subtasks

- [ ] Task 1: 配置 NextAuth.js (AC: #1)
  - [ ] 1.1 安装 next-auth @auth/drizzle-adapter
  - [ ] 1.2 创建 src/lib/auth/index.ts
  - [ ] 1.3 创建 src/lib/auth/options.ts
  - [ ] 1.4 配置 Drizzle Adapter
  - [ ] 1.5 配置 JWT 会话
- [ ] Task 2: 配置 Replicate API 客户端 (AC: #2)
  - [ ] 2.1 安装 replicate SDK
  - [ ] 2.2 创建 src/lib/replicate/index.ts
  - [ ] 2.3 创建 src/lib/replicate/vision.ts
  - [ ] 2.4 创建 src/lib/replicate/text.ts
  - [ ] 2.5 创建 src/lib/replicate/image.ts
- [ ] Task 3: 配置 R2 存储客户端 (AC: #3)
  - [ ] 3.1 安装 @aws-sdk/client-s3 @aws-sdk/lib-storage
  - [ ] 3.2 创建 src/lib/r2/index.ts
  - [ ] 3.3 创建 src/lib/r2/upload.ts
  - [ ] 3.4 创建 src/lib/r2/download.ts
- [ ] Task 4: 配置 Creem 支付集成 (AC: #4)
  - [ ] 4.1 安装 creem-sdk 或使用 REST API
  - [ ] 4.2 创建 src/lib/creem/index.ts
  - [ ] 4.3 创建 src/lib/creem/checkout.ts
  - [ ] 4.4 创建 src/lib/creem/webhook.ts
- [ ] Task 5: 创建环境变量模板 (AC: #5)
  - [ ] 5.1 创建 .env.example
  - [ ] 5.2 添加所有必需的环境变量
  - [ ] 5.3 添加变量说明注释
- [ ] Task 6: 统一 API 响应格式 (AC: #6, #7)
  - [ ] 6.1 创建统一错误处理
  - [ ] 6.2 创建类型定义

## Dev Notes

### NextAuth.js 配置

```typescript
// src/lib/auth/index.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import { DrizzleAdapter } from '@auth/drizzle-adapter';
import { db } from '@/lib/db';

export const authOptions = {
  adapter: DrizzleAdapter(db),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],
  session: {
    strategy: 'jwt',
  },
  callbacks: {
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.sub!;
      }
      return session;
    },
  },
};

export const { handlers, auth, signIn, signOut } = NextAuth(authOptions);
```

### Replicate API 客户端

```typescript
// src/lib/replicate/index.ts
import Replicate from 'replicate';

export const replicate = new Replicate({
  auth: process.env.REPLICATE_API_TOKEN!,
});

// src/lib/replicate/vision.ts
export async function analyzeImage(imageUrl: string) {
  const output = await replicate.run('your-vision-model', {
    input: { image: imageUrl },
  });
  return output;
}
```

### R2 存储客户端

```typescript
// src/lib/r2/index.ts
import { S3Client } from '@aws-sdk/client-s3';
import { Upload } from '@aws-sdk/lib-storage';
import { PassThrough } from 'stream';

export const r2 = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
  },
});

export async function uploadToR2(key: string, body: Buffer | ReadableStream): Promise<string> {
  // 上传实现
  return key;
}
```

### Creem 支付集成

```typescript
// src/lib/creem/index.ts
export const CREEM_API_URL = 'https://api.creem.io';

export async function createCheckoutSession(productId: string, userId: string) {
  const response = await fetch(`${CREEM_API_URL}/checkout`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${process.env.CREEM_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ productId, userId }),
  });
  return response.json();
}
```

### 环境变量模板

```env
# NextAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=http://localhost:3000

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/image_analyzer

# Replicate
REPLICATE_API_TOKEN=your_replicate_api_token

# Cloudflare R2
R2_ACCOUNT_ID=your_account_id
R2_ACCESS_KEY_ID=your_access_key_id
R2_SECRET_ACCESS_KEY=your_secret_access_key
R2_BUCKET_NAME=image-analyzer

# Creem
CREEM_API_KEY=your_creem_api_key
CREEM_WEBHOOK_SECRET=your_webhook_secret
```

### 命名规范

| 类别     | 规则             | 示例                       |
| -------- | ---------------- | -------------------------- |
| 服务模块 | kebab-case       | `replicate`, `r2`, `creem` |
| 服务文件 | kebab-case       | `vision.ts`, `checkout.ts` |
| 环境变量 | UPPER_SNAKE_CASE | `REPLICATE_API_TOKEN`      |

### Project Structure Notes

```
src/lib/
├── auth/
│   ├── index.ts       # NextAuth 导出
│   └── options.ts      # Auth 选项
├── replicate/
│   ├── index.ts       # Replicate 客户端
│   ├── vision.ts      # 视觉模型
│   ├── text.ts        # 文字模型
│   └── image.ts       # 生图模型
├── r2/
│   ├── index.ts       # R2 客户端
│   ├── upload.ts      # 上传函数
│   └── download.ts    # 下载函数
└── creem/
    ├── index.ts       # Creem 客户端
    ├── checkout.ts    # Checkout API
    └── webhook.ts    # Webhook 处理
```

### References

- 技术栈: [architecture.md#core-architectural-decisions](_bmad-output/planning-artifacts/architecture.md#core-architectural-decisions)
- API 格式: [architecture.md#format-patterns](_bmad-output/planning-artifacts/architecture.md#format-patterns)
- 集成点: [architecture.md#integration-points](_bmad-output/planning-artifacts/architecture.md#integration-points)

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

### File List

- `src/lib/auth/index.ts`
- `src/lib/auth/options.ts`
- `src/lib/replicate/index.ts`
- `src/lib/replicate/vision.ts`
- `src/lib/replicate/text.ts`
- `src/lib/replicate/image.ts`
- `src/lib/r2/index.ts`
- `src/lib/r2/upload.ts`
- `src/lib/r2/download.ts`
- `src/lib/creem/index.ts`
- `src/lib/creem/checkout.ts`
- `src/lib/creem/webhook.ts`
- `.env.example`
