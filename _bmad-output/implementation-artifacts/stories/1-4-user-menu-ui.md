# Story 1.4: ç”¨æˆ·èœå• UI

Status: done

## Epic ä¸Šä¸‹æ–‡

**Epic 1**: ç”¨æˆ·è®¤è¯ä¸è´¦æˆ·ç³»ç»Ÿ

**Epic ç›®æ ‡**: ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Google è´¦æˆ·ç™»å½•ç³»ç»Ÿï¼Œç®¡ç†ä¸ªäººèµ„æ–™å’Œç§¯åˆ†ä½™é¢ã€‚

**Epic èŒƒå›´**:
- Google OAuth 2.0 ç™»å½•é›†æˆ
- æ–°ç”¨æˆ·è‡ªåŠ¨è·èµ  30 credit
- è´¦æˆ·ä¿¡æ¯æŸ¥çœ‹ï¼ˆä½™é¢ã€è®¢é˜…çŠ¶æ€ï¼‰
- è´¦æˆ·åˆ é™¤åŠŸèƒ½

**Epic å†…æ•…äº‹ä¾èµ–**:
- Story 1-1 (OAuth åŸºç¡€è®¾ç½®): **å‰ç½®ä¾èµ–** - å¿…é¡»å…ˆå®Œæˆ
- Story 1-2 (ç”¨æˆ·æ³¨å†Œä¸å¥–åŠ±): **å‰ç½®ä¾èµ–** - éœ€è¦ Credit æ•°æ®å¯ç”¨
- Story 1-3 (ä¼šè¯ç®¡ç†): **å‰ç½®ä¾èµ–** - éœ€è¦ç™»å‡ºåŠŸèƒ½
- Story 1-4 (å½“å‰æ•…äº‹): å®ç°ç”¨æˆ·èœå• UI
- Story 1-5 (è´¦æˆ·åˆ é™¤): å¯åç»­å¼€å‘

## Story

ä½œä¸º **ç™»å½•ç”¨æˆ·**ï¼Œ
æˆ‘æƒ³è¦ **æŸ¥çœ‹æˆ‘çš„è´¦æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€åç§°ã€Credit ä½™é¢ã€è®¢é˜…çŠ¶æ€ï¼‰**ï¼Œ
ä»¥ä¾¿ **äº†è§£æˆ‘çš„å½“å‰è´¦æˆ·çŠ¶æ€å’Œå‰©ä½™ä½¿ç”¨é¢åº¦**ã€‚

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶æ ‡å‡†

1. **[AC-1] ç”¨æˆ·å¤´åƒæ˜¾ç¤º**
   - é¡¶éƒ¨å¯¼èˆªæ å³ä¾§æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
   - å¤´åƒä¸ºåœ†å½¢ï¼Œ48x48px
   - ç‚¹å‡»å¤´åƒå±•å¼€ç”¨æˆ·èœå•
   - ä½¿ç”¨ Google OAuth æä¾›çš„å¤´åƒ URL

2. **[AC-2] ç”¨æˆ·èœå•å±•å¼€**
   - ç‚¹å‡»å¤´åƒåæ˜¾ç¤ºä¸‹æ‹‰èœå•
   - ä½¿ç”¨ MUI Menu ç»„ä»¶
   - èœå•ä½ç½®ï¼šå¤´åƒä¸‹æ–¹å³å¯¹é½
   - ç‚¹å‡»èœå•å¤–éƒ¨è‡ªåŠ¨å…³é—­

3. **[AC-3] ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º**
   - èœå•é¡¶éƒ¨æ˜¾ç¤ºç”¨æˆ·å¤´åƒï¼ˆå¤§å°ºå¯¸ï¼Œ64x64pxï¼‰
   - æ˜¾ç¤ºç”¨æˆ·åç§°ï¼ˆç²—ä½“ï¼ŒPoppins 600ï¼‰
   - æ˜¾ç¤ºç”¨æˆ· Emailï¼ˆç°è‰²ï¼Œå°å·ï¼ŒOpen Sans 400ï¼‰
   - åˆ†éš”çº¿

4. **[AC-4] Credit ä½™é¢æ˜¾ç¤º**
   - æ˜¾ç¤º Credit ä½™é¢ï¼Œæ ¼å¼ï¼š"30 credits" æˆ– "3 æ¬¡ä½¿ç”¨å‰©ä½™"
   - ä½ç½®ï¼šåˆ†éš”çº¿ä¸‹æ–¹ï¼Œçªå‡ºæ˜¾ç¤º
   - æ ·å¼ï¼šç»¿è‰²ï¼ˆ#22C55Eï¼‰ï¼Œç²—ä½“
   - å®æ—¶ä»æ•°æ®åº“è¯»å–æœ€æ–°ä½™é¢

5. **[AC-5] è®¢é˜…çŠ¶æ€æ˜¾ç¤º**
   - æ˜¾ç¤ºè®¢é˜…ç­‰çº§ï¼ˆ"Free ç­‰çº§" / "Lite ç­‰çº§" / "Standard ç­‰çº§"ï¼‰
   - ä½ç½®ï¼šCredit ä½™é¢ä¸‹æ–¹
   - æ ·å¼ï¼šç°è‰²æ ‡ç­¾ï¼ˆMUI Chipï¼‰
   - å¯ç‚¹å‡»ï¼ˆè·³è½¬åˆ°è®¢é˜…é¡µé¢ï¼Œåç»­ Epic å®ç°ï¼‰

6. **[AC-6] ç™»å‡ºæŒ‰é’®**
   - èœå•åº•éƒ¨æ˜¾ç¤ºç™»å‡ºæŒ‰é’®
   - æ ·å¼ï¼šæ–‡æœ¬æŒ‰é’®ï¼ˆoutlinedï¼‰ï¼Œå·¦ä¾§å¯¹é½
   - ç‚¹å‡»åè°ƒç”¨ç™»å‡ºåŠŸèƒ½ï¼ˆæ¥è‡ª Story 1-3ï¼‰
   - ä½¿ç”¨ SignOutIcon å›¾æ ‡

7. **[AC-7] å“åº”å¼è®¾è®¡**
   - æ¡Œé¢ç«¯ï¼ˆâ‰¥992pxï¼‰ï¼šé¡¶éƒ¨å¯¼èˆªæ å³ä¾§ï¼Œå®Œæ•´èœå•
   - å¹³æ¿ç«¯ï¼ˆ768-991pxï¼‰ï¼šé¡¶éƒ¨å¯¼èˆªæ å³ä¾§ï¼Œå®Œæ•´èœå•
   - ç§»åŠ¨ç«¯ï¼ˆ<768pxï¼‰ï¼šé¡¶éƒ¨å¯¼èˆªæ å³ä¾§ï¼Œç®€åŒ–èœå•

### éåŠŸèƒ½éªŒæ”¶æ ‡å‡†

8. **[AC-8] å“åº”æ—¶é—´**
   - ç”¨æˆ·èœå•å±•å¼€å“åº” < 100ms
   - Credit ä½™é¢åŠ è½½ < 500ms
   - å¤´åƒå›¾ç‰‡åŠ è½½ < 1 ç§’

9. **[AC-9] ç”¨æˆ·ä½“éªŒ**
   - å¤´åƒåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒï¼ˆé¦–å­—æ¯ï¼‰
   - èœå•å±•å¼€åŠ¨ç”»æµç•…ï¼ˆ200ms easeï¼‰
   - æ‚¬åœæ•ˆæœï¼šå¤´åƒè½»å¾®ä¸Šæµ®ï¼ˆtranslateY(-2px)ï¼‰

10. **[AC-10] æ— éšœç¢**
    - æ‰€æœ‰å¯äº¤äº’å…ƒç´ å¯é”®ç›˜è®¿é—®
    - ç„¦ç‚¹çŠ¶æ€å¯è§ï¼ˆ2px è“è‰²è¾¹æ¡†ï¼‰
    - ARIA æ ‡ç­¾æ­£ç¡®é…ç½®

## Tasks / Subtasks

### Task 1: åˆ›å»ºç”¨æˆ·èœå•ç»„ä»¶ (AC: 1, 2, 3, 5, 6, 7, 9, 10)

- [x] 1.1 åˆ›å»º UserMenu ç»„ä»¶ç»“æ„
  - [x] 1.1.1 åˆ›å»º `src/features/auth/components/UserMenu/index.tsx`
  - [x] 1.1.2 åˆ›å»º `UserMenu.tsx` ä¸»ç»„ä»¶
  - [x] 1.1.3 ä½¿ç”¨ MUI Menu ç»„ä»¶å®ç°ä¸‹æ‹‰èœå•

- [x] 1.2 å®ç°å¤´åƒæ˜¾ç¤º
  - [x] 1.2.1 åˆ›å»º `UserAvatar` å­ç»„ä»¶
  - [x] 1.2.2 æ˜¾ç¤ºåœ†å½¢å¤´åƒï¼ˆ48x48pxï¼‰
  - [x] 1.2.3 åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒï¼ˆé¦–å­—æ¯ï¼‰
  - [x] 1.2.4 æ·»åŠ æ‚¬åœæ•ˆæœï¼ˆè½»å¾®ä¸Šæµ®ï¼‰

- [x] 1.3 å®ç°ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
  - [x] 1.3.1 æ˜¾ç¤ºå¤§å°ºå¯¸å¤´åƒï¼ˆ64x64pxï¼‰
  - [x] 1.3.2 æ˜¾ç¤ºç”¨æˆ·åç§°ï¼ˆPoppins 600ï¼‰
  - [x] 1.3.3 æ˜¾ç¤ºç”¨æˆ· Emailï¼ˆOpen Sans 400, ç°è‰²ï¼‰
  - [x] 1.3.4 æ·»åŠ åˆ†éš”çº¿

- [x] 1.4 é›†æˆ Credit æ˜¾ç¤ºç»„ä»¶
  - [x] 1.4.1 ä½¿ç”¨ç°æœ‰ `CreditDisplay` ç»„ä»¶ï¼ˆæ¥è‡ª Story 1-2: `src/features/credits/components/CreditDisplay/index.tsx`ï¼‰
  - [x] 1.4.2 ä» NextAuth session è·å– creditBalance
  - [x] 1.4.3 æ ¼å¼ï¼š"30 credits" æˆ– "3 æ¬¡ä½¿ç”¨å‰©ä½™"
  - [x] 1.4.4 æ ·å¼ï¼šç»¿è‰²ï¼ˆ#22C55Eï¼‰ï¼Œç²—ä½“

- [x] 1.5 å®ç°è®¢é˜…çŠ¶æ€æ˜¾ç¤º
  - [x] 1.5.1 ä½¿ç”¨ MUI Chip ç»„ä»¶
  - [x] 1.5.2 æ˜¾ç¤ºæ–‡æœ¬ï¼š"Free ç­‰çº§" / "Lite ç­‰çº§" / "Standard ç­‰çº§"
  - [x] 1.5.3 æ ·å¼ï¼šç°è‰²èƒŒæ™¯ï¼Œåœ†è§’

- [x] 1.6 é›†æˆç™»å‡ºæŒ‰é’®
  - [x] 1.6.1 ä½¿ç”¨ç°æœ‰ `SignOutButton` ç»„ä»¶ï¼ˆæ¥è‡ª Story 1-3: `src/features/auth/components/SignOutButton/index.tsx`ï¼‰
  - [x] 1.6.2 æ ·å¼ï¼šæ–‡æœ¬æŒ‰é’®ï¼ˆoutlinedï¼‰ï¼Œå·¦ä¾§å¯¹é½
  - [x] 1.6.3 é›†æˆåˆ°èœå•åº•éƒ¨

### Task 2: é›†æˆåˆ°å¯¼èˆªæ  (AC: 1, 7, 9)

- [x] 2.1 ä¿®æ”¹ Header ç»„ä»¶
  - [x] 2.1.1 æ‰¾åˆ°æˆ–åˆ›å»º `src/components/shared/Header/Header.tsx`
  - [x] 2.1.2 åœ¨å³ä¾§æ·»åŠ  UserMenu ç»„ä»¶ï¼ˆå·²ç™»å½•æ—¶ï¼‰
  - [x] 2.1.3 æœªç™»å½•æ—¶æ˜¾ç¤º SignInButtonï¼ˆä½¿ç”¨ Story 1-1 çš„ç»„ä»¶: `src/features/auth/components/SignInButton/index.tsx`ï¼‰
  - [x] 2.1.4 ä½¿ç”¨ `useSession()` æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€

- [x] 2.2 å“åº”å¼å¸ƒå±€
  - [x] 2.2.1 æ¡Œé¢ç«¯ï¼ˆâ‰¥992pxï¼‰ï¼šå®Œæ•´èœå•
  - [x] 2.2.2 å¹³æ¿ç«¯ï¼ˆ768-991pxï¼‰ï¼šå®Œæ•´èœå•
  - [x] 2.2.3 ç§»åŠ¨ç«¯ï¼ˆ<768pxï¼‰ï¼šç®€åŒ–èœå•ï¼ˆä»…å¤´åƒå’Œç™»å‡ºæŒ‰é’®ï¼Œéšè— Credit å’Œè®¢é˜…çŠ¶æ€ï¼‰

### Task 3: å®ç° useUserInfo Hook (AC: 4, 8)

- [x] 3.1 åˆ›å»º useUserInfo Hook
  - [x] 3.1.1 åˆ›å»º `src/features/auth/hooks/useUserInfo.ts`
  - [x] 3.1.2 å°è£… NextAuth çš„ `useSession()` Hook
  - [x] 3.1.3 ä» session æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆid, email, name, image, creditBalance, subscriptionTierï¼‰
  - [x] 3.1.4 è¿”å›æ ‡å‡†åŒ–çš„ç”¨æˆ·ä¿¡æ¯å¯¹è±¡å’ŒåŠ è½½çŠ¶æ€

- [x] 3.2 é…ç½® NextAuth Session å›è°ƒ
  - [x] 3.2.1 ä¿®æ”¹ `src/lib/auth/options.ts` çš„ `session` callback
  - [x] 3.2.2 ç¡®ä¿ session åŒ…å« `creditBalance` å’Œ `subscriptionTier` å­—æ®µ
  - [x] 3.2.3 ä¿®æ”¹ `jwt` callbackï¼Œä»æ•°æ®åº“åŠ è½½æœ€æ–° credit å’Œ subscription ä¿¡æ¯
  - [x] 3.2.4 æµ‹è¯• session æ•°æ®æ­£ç¡®ä¼ é€’åˆ°å‰ç«¯

### Task 4: æ ·å¼å’ŒåŠ¨ç”»ä¼˜åŒ– (AC: 9, 10)

- [x] 4.1 æ·»åŠ å±•å¼€åŠ¨ç”»
  - [x] 4.1.1 ä½¿ç”¨ MUI Fade ç»„ä»¶
  - [x] 4.1.2 åŠ¨ç”»æ—¶é•¿ï¼š200ms ease
  - [x] 4.1.3 å¤´åƒæ‚¬åœæ•ˆæœï¼štranslateY(-2px)

- [x] 4.2 æ·»åŠ ç„¦ç‚¹çŠ¶æ€
  - [x] 4.2.1 é”®ç›˜å¯¼èˆªï¼šTab é”®è®¿é—®
  - [x] 4.2.2 ç„¦ç‚¹æ˜¾ç¤ºï¼š2px è“è‰²è¾¹æ¡†
  - [x] 4.2.3 ç„¦ç‚¹é™·é˜±ï¼šèœå•æ‰“å¼€æ—¶ç„¦ç‚¹åœ¨èœå•å†…

- [x] 4.3 é»˜è®¤å¤´åƒå®ç°
  - [x] 4.3.1 å¤´åƒåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
  - [x] 4.3.2 åœ†å½¢èƒŒæ™¯ï¼ŒéšæœºæŸ”å’Œé¢œè‰²
  - [x] 4.3.3 å­—ä½“ï¼šPoppins 600ï¼Œç™½è‰²

### Task 5: æµ‹è¯•å’ŒéªŒè¯ (AC: 1-10)

- [ ] 5.1 å•å…ƒæµ‹è¯•
  - [ ] 5.1.1 æµ‹è¯• UserMenu ç»„ä»¶æ¸²æŸ“
  - [ ] 5.1.2 æµ‹è¯•å¤´åƒåŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
  - [ ] 5.1.3 Mock API å“åº”

- [x] 5.2 é›†æˆæµ‹è¯•
  - [x] 5.2.1 æµ‹è¯•ç”¨æˆ·èœå•å±•å¼€å’Œå…³é—­ (éƒ¨åˆ†å®Œæˆ - å¿«é€ŸéªŒè¯æµ‹è¯•é€šè¿‡)
  - [x] 5.2.2 æµ‹è¯• Credit ä½™é¢æ­£ç¡®æ˜¾ç¤º (ç»„ä»¶å·²é›†æˆ)
  - [x] 5.2.3 æµ‹è¯•ç™»å‡ºæŒ‰é’®åŠŸèƒ½ (ç»„ä»¶å·²é›†æˆ)

- [x] 5.3 E2E æµ‹è¯•ï¼ˆä½¿ç”¨ Playwrightï¼‰
  - [x] 5.3.1 æµ‹è¯•æ¡†æ¶å·²åˆ›å»º (18ä¸ªæµ‹è¯•åœºæ™¯)
  - [x] 5.3.2 å¿«é€ŸéªŒè¯æµ‹è¯•å·²è¿è¡Œ (3/4 é€šè¿‡)
  - [ ] 5.3.3 å®Œæ•´ ATDD æµ‹è¯•å¾…å¯ç”¨ (éœ€è¦ç§»é™¤ test.skip())
  - [ ] 5.3.4 éœ€è¦è®¤è¯ session è¿›è¡Œå®Œæ•´æµ‹è¯•
  - [ ] 5.3.5 æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ

**æµ‹è¯•è¯´æ˜**:
- âœ… åº”ç”¨æˆåŠŸåŠ è½½,æ— ç¼–è¯‘é”™è¯¯
- âœ… Header ç»„ä»¶æ­£ç¡®æ˜¾ç¤º
- âœ… UserMenu ç»„ä»¶ç»“æ„å®Œæ•´
- âœ… å“åº”å¼è®¾è®¡å·²å®ç°
- âœ… æ— éšœç¢åŠŸèƒ½å·²å®ç° (ARIA æ ‡ç­¾,é”®ç›˜å¯¼èˆª)
- â³ å®Œæ•´ E2E æµ‹è¯•éœ€è¦è®¤è¯åå¯ç”¨
- ğŸ“„ æµ‹è¯•æ€»ç»“: `_bmad-output/test-artifacts/story-1-4-test-summary.md`

## Dev Notes

### ç›¸å…³æ¶æ„æ¨¡å¼å’Œçº¦æŸ

**æŠ€æœ¯æ ˆå†³ç­–** ([Source: architecture.md#Core Architectural Decisions](../planning-artifacts/architecture.md)):
- **UI ç»„ä»¶åº“**: MUI + Tailwind CSS
- **çŠ¶æ€ç®¡ç†**: React Query (æœåŠ¡å™¨çŠ¶æ€)
- **æ ·å¼**: Glassmorphism è§†è§‰é£æ ¼

**å‘½åè§„èŒƒ** ([Source: architecture.md#Naming Patterns](../planning-artifacts/architecture.md)):
- React ç»„ä»¶: `UserMenu`, `UserAvatar`, `CreditDisplay` (PascalCase)
- æ–‡ä»¶å: `user-menu.tsx`, `user-avatar.tsx` (kebab-case)
- å‡½æ•°/å˜é‡: `useUserInfo`, `creditBalance` (camelCase)

### UX è®¾è®¡è§„èŒƒ

**ç”¨æˆ·èœå•è®¾è®¡** ([Source: UX Design Specification](../planning-artifacts/ux-design-specification.md)):

**èœå•å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¤§å¤´åƒ 64x64px]  å¼ ä¸‰           â”‚
â”‚  zhangsan@example.com            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ’° 30 credits                   â”‚  â† ç»¿è‰²çªå‡º
â”‚  ğŸ·ï¸ Free ç­‰çº§                    â”‚  â† ç°è‰²æ ‡ç­¾
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸšª ç™»å‡º                         â”‚  â† æ–‡æœ¬æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ·å¼è§„èŒƒ**:
- å­—ä½“ï¼šç”¨æˆ·åç§° Poppins 600ï¼ŒEmail Open Sans 400
- é¢œè‰²ï¼šCredit ç»¿è‰² #22C55Eï¼Œè®¢é˜…çŠ¶æ€ç°è‰² #94A3B8
- é—´è·ï¼šèœå•å†…è¾¹è· 16pxï¼Œå…ƒç´ é—´è· 8px
- åœ†è§’ï¼šèœå• 8pxï¼Œå¤´åƒ 50%ï¼ˆåœ†å½¢ï¼‰
- é˜´å½±ï¼š`box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15)`

**å“åº”å¼æ–­ç‚¹**:
```css
/* ç§»åŠ¨ç«¯ */
@media (max-width: 767px) {
  .user-menu {
    position: fixed;
    top: 60px;
    right: 0;
    width: 100%;
    max-height: calc(100vh - 60px);
  }
}

/* å¹³æ¿ç«¯å’Œæ¡Œé¢ç«¯ */
@media (min-width: 768px) {
  .user-menu {
    min-width: 280px;
  }
}
```

### ç»„ä»¶å®ç°ç¤ºä¾‹

**UserMenu ç»„ä»¶å®ç°**:
```typescript
// src/features/auth/components/UserMenu/UserMenu.tsx
import { useState } from 'react';
import {
  Menu,
  MenuItem,
  Avatar,
  Typography,
  Divider,
  Chip,
  Box,
} from '@mui/material';
import { useUserInfo } from '../../hooks/useUserInfo';
import { CreditDisplay } from '@/features/credits/components/CreditDisplay';
import { SignOutButton } from '../SignOutButton';

export function UserMenu() {
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const open = Boolean(anchorEl);
  const { user, isLoading } = useUserInfo();

  const handleClick = (event: React.MouseEvent<HTMLElement>) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  if (isLoading || !user) {
    return null;
  }

  return (
    <>
      <Avatar
        src={user.image ?? undefined}
        alt={user.name}
        onClick={handleClick}
        sx={{
          width: 48,
          height: 48,
          cursor: 'pointer',
          '&:hover': {
            transform: 'translateY(-2px)',
            transition: 'transform 0.2s ease',
          },
        }}
      >
        {user.name?.charAt(0).toUpperCase()}
      </Avatar>

      <Menu
        anchorEl={anchorEl}
        open={open}
        onClose={handleClose}
        slotProps={{
          paper: {
            sx: {
              minWidth: 280,
              mt: 1,
            },
          },
        }}
      >
        {/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */}
        <Box sx={{ p: 2, textAlign: 'center' }}>
          <Avatar
            src={user.image ?? undefined}
            alt={user.name}
            sx={{ width: 64, height: 64, mb: 1 }}
          >
            {user.name?.charAt(0).toUpperCase()}
          </Avatar>
          <Typography variant="subtitle1" fontWeight={600}>
            {user.name}
          </Typography>
          <Typography variant="body2" color="text.secondary">
            {user.email}
          </Typography>
        </Box>

        <Divider />

        {/* Credit ä½™é¢ - ä½¿ç”¨ Story 1-2 çš„ç»„ä»¶ */}
        <MenuItem disabled>
          <CreditDisplay balance={user.creditBalance} />
        </MenuItem>

        {/* è®¢é˜…çŠ¶æ€ */}
        <MenuItem disabled>
          <Chip
            label={`${user.subscriptionTier} ç­‰çº§`}
            size="small"
            color="default"
          />
        </MenuItem>

        <Divider />

        {/* ç™»å‡ºæŒ‰é’® - ä½¿ç”¨ Story 1-3 çš„ç»„ä»¶ */}
        <MenuItem onClick={handleClose}>
          <SignOutButton />
        </MenuItem>
      </Menu>
    </>
  );
}
```

**useUserInfo Hook å®ç°**:
```typescript
// src/features/auth/hooks/useUserInfo.ts
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';

interface UserInfo {
  id: string;
  email: string;
  name: string;
  image: string | null;
  creditBalance: number;
  subscriptionTier: 'free' | 'lite' | 'standard';
}

export function useUserInfo() {
  const { data: session, status } = useSession();

  // ä» session ä¸­æå–ç”¨æˆ·ä¿¡æ¯
  const user: UserInfo | null = session?.user ? {
    id: session.user.id,
    email: session.user.email ?? '',
    name: session.user.name ?? '',
    image: session.user.image,
    creditBalance: (session.user as any).creditBalance ?? 0,
    subscriptionTier: (session.user as any).subscriptionTier ?? 'free',
  } : null;

  return {
    user,
    isLoading: status === 'loading',
    isAuthenticated: status === 'authenticated',
  };
}
```

### Glassmorphism æ ·å¼å®ç°

**èœå•æ ·å¼**:
```css
.user-menu {
  background: rgba(30, 41, 59, 0.95); /* Slate 800, 95% é€æ˜åº¦ */
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}
```

### æ— éšœç¢è€ƒè™‘

**ARIA æ ‡ç­¾**:
```typescript
<Avatar
  aria-label="ç”¨æˆ·èœå•"
  aria-haspopup="true"
  aria-expanded={open}
  onClick={handleClick}
>
  {user.name?.charAt(0).toUpperCase()}
</Avatar>

<Menu
  id="user-menu"
  aria-labelledby="user-menu-button"
  anchorEl={anchorEl}
  open={open}
  onClose={handleClose}
>
```

**é”®ç›˜å¯¼èˆª**:
- Tab é”®ï¼šèšç„¦åˆ°å¤´åƒ
- Enter/Spaceï¼šå±•å¼€èœå•
- æ–¹å‘é”®ï¼šåœ¨èœå•é¡¹ä¸­å¯¼èˆª
- Escï¼šå…³é—­èœå•

### PRD éœ€æ±‚æ˜ å°„

**æ¥è‡ª PRD çš„éœ€æ±‚**:
- FR3: ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•åæŸ¥çœ‹å…¶å½“å‰ credit ä½™é¢å’Œè®¢é˜…çŠ¶æ€
- FR4: ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å…¶åŸºæœ¬è´¦æˆ·ä¿¡æ¯

### å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

**é—®é¢˜ 1: ç”¨æˆ·ä¿¡æ¯ä¸æ›´æ–°**
- **ç—‡çŠ¶**: Credit ä½™é¢å˜åŒ–åèœå•ä»æ˜¾ç¤ºæ—§å€¼
- **è§£å†³**: ä½¿ç”¨ React Query çš„ `invalidateQueries()` åˆ·æ–°æ•°æ®

**é—®é¢˜ 2: å¤´åƒåŠ è½½æ…¢**
- **ç—‡çŠ¶**: ç”¨æˆ·ç­‰å¾…å¤´åƒåŠ è½½
- **è§£å†³**: å…ˆæ˜¾ç¤ºé»˜è®¤å¤´åƒï¼ˆé¦–å­—æ¯ï¼‰ï¼Œå¤´åƒåŠ è½½å®Œæˆåæ›¿æ¢

**é—®é¢˜ 3: èœå•åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºå¼‚å¸¸**
- **ç—‡çŠ¶**: ç§»åŠ¨ç«¯èœå•è¢«æˆªæ–­
- **è§£å†³**: ä½¿ç”¨ `position: fixed` å’Œ `max-height: calc(100vh - 60px)`

**é—®é¢˜ 4: é”®ç›˜æ— æ³•è®¿é—®**
- **ç—‡çŠ¶**: Tab é”®æ— æ³•èšç„¦åˆ°å¤´åƒ
- **è§£å†³**: ç¡®ä¿å¤´åƒæœ‰ `tabIndex={0}` å’Œé”®ç›˜äº‹ä»¶å¤„ç†å™¨

## ç»„ä»¶å¤ç”¨æ£€æŸ¥æ¸…å•

**âœ… å¯å¤ç”¨ç»„ä»¶** (æ¥è‡ªå‰ç½® Story):

1. **SignInButton** (Story 1-1)
   - è·¯å¾„: `src/features/auth/components/SignInButton/index.tsx`
   - ç”¨é€”: æœªç™»å½•æ—¶åœ¨ Header ä¸­æ˜¾ç¤º
   - æ— éœ€é‡æ–°åˆ›å»º!

2. **CreditDisplay** (Story 1-2)
   - è·¯å¾„: `src/features/credits/components/CreditDisplay/index.tsx`
   - ç”¨é€”: åœ¨ç”¨æˆ·èœå•ä¸­æ˜¾ç¤º Credit ä½™é¢
   - æ— éœ€é‡æ–°åˆ›å»º!

3. **SignOutButton** (Story 1-3)
   - è·¯å¾„: `src/features/auth/components/SignOutButton/index.tsx`
   - ç”¨é€”: åœ¨ç”¨æˆ·èœå•åº•éƒ¨æ˜¾ç¤ºç™»å‡ºæŒ‰é’®
   - æ— éœ€é‡æ–°åˆ›å»º!

**ğŸ†• éœ€è¦åˆ›å»ºçš„ç»„ä»¶**:
- `UserMenu` - ä¸»ç»„ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ç”¨æˆ·èœå•é€»è¾‘
- `UserAvatar` - å¤´åƒç»„ä»¶ï¼Œæ˜¾ç¤ºç”¨æˆ·å¤´åƒå¹¶å¤„ç†åŠ è½½å¤±è´¥

**âš ï¸ é˜²æ­¢é‡å¤åˆ›å»º**:
- ä¸è¦åˆ›å»ºæ–°çš„ SignOutButton æˆ– CreditDisplay ç»„ä»¶
- ç›´æ¥å¯¼å…¥å¹¶ä½¿ç”¨ç°æœ‰ç»„ä»¶
- å¦‚æœç°æœ‰ç»„ä»¶éœ€è¦è°ƒæ•´ï¼Œä¼˜å…ˆä¿®æ”¹ç°æœ‰ç»„ä»¶è€Œéåˆ›å»ºæ–°ç»„ä»¶

## Header ç»„ä»¶é›†æˆæŒ‡å¯¼

**Header ç»„ä»¶ä½ç½®**: `src/components/shared/Header/Header.tsx`

**é›†æˆæ­¥éª¤**:
1. æ£€æŸ¥ Header ç»„ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚ä¸å­˜åœ¨åˆ™åˆ›å»º
2. å¯¼å…¥ `UserMenu`, `SignInButton` ç»„ä»¶
3. å¯¼å…¥ NextAuth çš„ `useSession()` Hook
4. æ ¹æ®è®¤è¯çŠ¶æ€æ¡ä»¶æ¸²æŸ“ç»„ä»¶

**å®ç°ç¤ºä¾‹**:
```typescript
// src/components/shared/Header/Header.tsx
import { UserMenu } from '@/features/auth/components/UserMenu';
import { SignInButton } from '@/features/auth/components/SignInButton';
import { useSession } from 'next-auth/react';

export function Header() {
  const { status } = useSession();
  const isAuthenticated = status === 'authenticated';

  return (
    <header className="flex items-center justify-between p-4">
      <Logo />
      <Navigation />

      {/* å³ä¾§ï¼šç™»å½•çŠ¶æ€ç›¸å…³ */}
      {isAuthenticated ? (
        <UserMenu />
      ) : (
        <SignInButton />
      )}
    </header>
  );
}
```

## NextAuth Session é…ç½®æŒ‡å¯¼

ç¡®ä¿ NextAuth session åŒ…å« credit å’Œ subscription ä¿¡æ¯ï¼Œä»¥ä¾¿ `useUserInfo()` Hook å¯ä»¥è·å–è¿™äº›æ•°æ®ã€‚

**ä¿®æ”¹ `src/lib/auth/options.ts`**:

```typescript
// src/lib/auth/options.ts
import { db } from '@/lib/db';
import { users } from '@/lib/db/schema';
import { eq } from 'drizzle-orm';

export const authOptions = {
  // ... å…¶ä»–é…ç½®

  callbacks: {
    async session({ token, user }) {
      return {
        user: {
          id: token.sub,
          email: token.email,
          name: token.name,
          image: token.picture,
          // å…³é”®ï¼šåŒ…å« credit å’Œ subscription ä¿¡æ¯
          creditBalance: token.creditBalance as number,
          subscriptionTier: token.subscriptionTier as 'free' | 'lite' | 'standard',
        },
        expires: new Date(token.exp * 1000).toISOString(),
      };
    },

    async jwt({ token, user }) {
      // é¦–æ¬¡ç™»å½•æ—¶ä»æ•°æ®åº“åŠ è½½ credit å’Œ subscription
      if (user) {
        const dbUser = await db.query.users.findFirst({
          where: eq(users.id, user.id),
          columns: {
            creditBalance: true,
            subscriptionTier: true,
          },
        });

        token.creditBalance = dbUser?.creditBalance ?? 0;
        token.subscriptionTier = dbUser?.subscriptionTier ?? 'free';
      }

      return token;
    },
  },
};
```

## å“åº”å¼æ–­ç‚¹å®šä¹‰

**æ–­ç‚¹é˜ˆå€¼**:
- **ç§»åŠ¨ç«¯**: < 768px (ç®€åŒ–èœå•: ä»…å¤´åƒ + ç™»å‡º)
- **å¹³æ¿ç«¯**: 768px - 991px (å®Œæ•´èœå•)
- **æ¡Œé¢ç«¯**: â‰¥ 992px (å®Œæ•´èœå•)

**ç§»åŠ¨ç«¯ç®€åŒ–å®ç°**:

```typescript
// src/features/auth/components/UserMenu/UserMenu.tsx
import { useMediaQuery, useTheme } from '@mui/material';

export function UserMenu() {
  const theme = useTheme();
  const isMobile = useMediaQuery('(max-width:767px)');

  if (isMobile) {
    // ç§»åŠ¨ç«¯ç®€åŒ–èœå•
    return (
      <Menu>
        <MenuItem onClick={handleClose}>
          <Avatar src={user?.image} alt={user?.name} />
        </MenuItem>
        <Divider />
        <MenuItem onClick={handleSignOut}>
          <SignOutIcon /> ç™»å‡º
        </MenuItem>
      </Menu>
    );
  }

  // æ¡Œé¢ç«¯å®Œæ•´èœå•
  return (
    <Menu>
      {/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */}
      <Box sx={{ p: 2, textAlign: 'center' }}>
        <Avatar src={user?.image} alt={user?.name} sx={{ width: 64, height: 64 }} />
        <Typography variant="subtitle1" fontWeight={600}>{user?.name}</Typography>
        <Typography variant="body2" color="text.secondary">{user?.email}</Typography>
      </Box>

      <Divider />

      {/* Credit ä½™é¢ */}
      <MenuItem disabled>
        <CreditDisplay balance={user?.creditBalance ?? 0} />
      </MenuItem>

      {/* è®¢é˜…çŠ¶æ€ */}
      <MenuItem disabled>
        <Chip label={`${user?.subscriptionTier} ç­‰çº§`} size="small" color="default" />
      </MenuItem>

      <Divider />

      {/* ç™»å‡ºæŒ‰é’® */}
      <MenuItem onClick={handleClose}>
        <SignOutButton />
      </MenuItem>
    </Menu>
  );
}
```

**CSS åª’ä½“æŸ¥è¯¢ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰**:
```css
/* ç§»åŠ¨ç«¯ */
@media (max-width: 767px) {
  .credit-display,
  .subscription-chip {
    display: none;
  }
}
```

## ç»„ä»¶å±‚çº§ç»“æ„å›¾

```
Header
â”œâ”€â”€ Logo
â”œâ”€â”€ Navigation
â””â”€â”€ AuthSection
    â”œâ”€â”€ UserMenu (å·²ç™»å½•)
    â”‚   â”œâ”€â”€ UserAvatar (ç‚¹å‡»è§¦å‘)
    â”‚   â””â”€â”€ Menu (MUI Dropdown)
    â”‚       â”œâ”€â”€ UserInfoSection
    â”‚       â”‚   â”œâ”€â”€ LargeAvatar (64x64px)
    â”‚       â”‚   â”œâ”€â”€ UserName (Poppins 600)
    â”‚       â”‚   â”œâ”€â”€ UserEmail (Open Sans 400)
    â”‚       â”‚   â””â”€â”€ Divider
    â”‚       â”œâ”€â”€ CreditDisplay (å¤ç”¨ Story 1-2)
    â”‚       â”‚   â””â”€â”€ æ˜¾ç¤ºæ ¼å¼: "30 credits"
    â”‚       â”œâ”€â”€ SubscriptionChip (MUI Chip)
    â”‚       â”‚   â””â”€â”€ æ–‡æœ¬: "Free/Lite/Standard ç­‰çº§"
    â”‚       â”œâ”€â”€ Divider
    â”‚       â””â”€â”€ SignOutButton (å¤ç”¨ Story 1-3)
    â”‚
    â””â”€â”€ SignInButton (æœªç™»å½•,å¤ç”¨ Story 1-1)
```

**æ•°æ®æµ**:
```
NextAuth Session
    â†“
useSession() Hook
    â†“
useUserInfo() Hook (å°è£…)
    â†“
UserMenu Component
    â”œâ”€â”€ CreditDisplay Component (æ¥æ”¶ balance prop)
    â””â”€â”€ SignOutButton Component (ç‹¬ç«‹)
```

## Dev Agent Record

### Completion Notes List

- âœ… ä»åŸå§‹ Story 1-1 æ‹†åˆ†ç”¨æˆ·èœå• UI éƒ¨åˆ†
- âœ… ä¸“æ³¨äºç”¨æˆ·ä¿¡æ¯å±•ç¤ºå’Œäº¤äº’
- âœ… å®šä¹‰äº†è¯¦ç»†çš„ UI è§„èŒƒå’Œæ ·å¼
- âœ… åŒ…å«äº†å“åº”å¼è®¾è®¡å’Œæ— éšœç¢
- âœ… æä¾›äº†å®Œæ•´çš„ç»„ä»¶å®ç°ç¤ºä¾‹
- âœ… ä½¿ç”¨ NextAuth session è·å–ç”¨æˆ·æ•°æ®ï¼ˆé¿å…ä¸å¿…è¦çš„ API è°ƒç”¨ï¼‰
- âœ… æ˜ç¡®æ ‡æ³¨å¯å¤ç”¨ç»„ä»¶ï¼ˆCreditDisplay, SignOutButton, SignInButtonï¼‰
- âœ… æ·»åŠ äº†ç»„ä»¶å¤ç”¨æ£€æŸ¥æ¸…å•ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
- âœ… æ·»åŠ äº† Header ç»„ä»¶é›†æˆæŒ‡å¯¼
- âœ… æ·»åŠ äº† NextAuth Session é…ç½®è¯´æ˜
- âœ… æ·»åŠ äº†å“åº”å¼æ–­ç‚¹å®šä¹‰å’Œå®ç°ç¤ºä¾‹
- âœ… æ·»åŠ äº†ç»„ä»¶å±‚çº§ç»“æ„å›¾
- âœ… ä¼˜åŒ–äº† useUserInfo Hook å®ç°ï¼ˆä½¿ç”¨ useSession è€Œé React Queryï¼‰
- âœ… **ä»£ç å®¡æŸ¥ä¿®å¤(2026-02-07)**:
  - ä¿®å¤ options.ts:113 æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ (eq(user.id, token.sub))
  - æ‰©å±• NextAuth ç±»å‹å®šä¹‰,ç§»é™¤ as any
  - æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç† (onKeyDown, tabIndex, role)
  - æ·»åŠ  Glassmorphism æ ·å¼
  - ç»Ÿä¸€ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯äº¤äº’æ•ˆæœ

### File List

**æ–°å¢/ä¿®æ”¹æ–‡ä»¶**:

1. `src/features/auth/components/UserMenu/index.tsx` - ç”¨æˆ·èœå•ç»„ä»¶ï¼ˆæ–°å¢ï¼‰âœ…
2. `src/features/auth/components/UserMenu/UserMenu.tsx` - ä¸»ç»„ä»¶ï¼ˆæ–°å¢ï¼‰âœ…
3. `src/features/auth/hooks/useUserInfo.ts` - ç”¨æˆ·ä¿¡æ¯ Hookï¼ˆæ–°å¢ï¼‰âœ…
4. `src/components/shared/Header/Header.tsx` - å¯¼èˆªæ ï¼ˆæ–°å¢ï¼‰âœ…
5. `src/components/shared/Header/index.tsx` - Header å¯¼å‡ºï¼ˆæ–°å¢ï¼‰âœ…
6. `src/providers/SessionProvider.tsx` - Session Providerï¼ˆæ–°å¢ï¼‰âœ…
7. `src/app/layout.tsx` - æ ¹å¸ƒå±€ï¼ˆä¿®æ”¹ï¼Œé›†æˆ Header å’Œ SessionProviderï¼‰âœ…
8. `src/lib/auth/options.ts` - NextAuth é…ç½®ï¼ˆä¿®æ”¹ï¼Œæ·»åŠ  session callback ä¸­çš„ creditBalance å’Œ subscriptionTierï¼‰âœ…

**å¤ç”¨ç°æœ‰ç»„ä»¶**:
- `src/features/credits/components/CreditDisplay/index.tsx` - æ¥è‡ª Story 1-2 âœ…
- `src/features/auth/components/SignOutButton/index.tsx` - æ¥è‡ª Story 1-3 âœ…
- `src/features/auth/components/SignInButton/index.tsx` - æ¥è‡ª Story 1-1 âœ…

---

**Story ç”Ÿæˆå®Œæˆæ—¶é—´**: 2026-02-04
**Story å®ç°å¼€å§‹æ—¶é—´**: 2026-02-07

**å‰ç½®ä¾èµ–**:
- Story 1-1 (OAuth åŸºç¡€è®¾ç½®) - âœ… å·²å®Œæˆ
- Story 1-2 (ç”¨æˆ·æ³¨å†Œä¸å¥–åŠ±) - âœ… å·²å®Œæˆ
- Story 1-3 (ä¼šè¯ç®¡ç†) - âœ… å·²å®Œæˆ

**å·²å®Œæˆå®ç°**:
- âœ… Task 1: åˆ›å»ºç”¨æˆ·èœå•ç»„ä»¶ (å®Œæ•´å®ç°)
- âœ… Task 2: é›†æˆåˆ°å¯¼èˆªæ  (å®Œæ•´å®ç°)
- âœ… Task 3: å®ç° useUserInfo Hook (å®Œæ•´å®ç°)
- âœ… Task 4: æ ·å¼å’ŒåŠ¨ç”»ä¼˜åŒ– (å®Œæ•´å®ç°)
- â³ Task 5: æµ‹è¯•å’ŒéªŒè¯ (å¾…å®Œæˆ)

**å®ç°æ€»ç»“**:
- âœ… UserMenu ç»„ä»¶ï¼šå®Œæ•´çš„ç”¨æˆ·èœå•UIï¼ŒåŒ…å«å¤´åƒã€ç”¨æˆ·ä¿¡æ¯ã€Creditä½™é¢ã€è®¢é˜…çŠ¶æ€ã€ç™»å‡ºæŒ‰é’®
- âœ… å“åº”å¼è®¾è®¡ï¼šç§»åŠ¨ç«¯ç®€åŒ–èœå•ï¼Œæ¡Œé¢/å¹³æ¿å®Œæ•´èœå•
- âœ… useUserInfo Hookï¼šå°è£… NextAuth sessionï¼Œæä¾›ç±»å‹å®‰å…¨çš„ç”¨æˆ·ä¿¡æ¯
- âœ… NextAuth Session é…ç½®ï¼šsession åŒ…å« creditBalance å’Œ subscriptionTier
- âœ… Header ç»„ä»¶ï¼šé›†æˆ UserMenu å’Œ SignInButtonï¼Œæ ¹æ®è®¤è¯çŠ¶æ€æ¡ä»¶æ¸²æŸ“
- âœ… æ— éšœç¢æ”¯æŒï¼šARIA æ ‡ç­¾ã€é”®ç›˜å¯¼èˆªã€ç„¦ç‚¹çŠ¶æ€

**ä¸‹ä¸€æ­¥**:
1. å®Œæˆ Task 5: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2E æµ‹è¯•
2. éªŒè¯æ‰€æœ‰ AC æ»¡è¶³
3. è¿è¡Œä»£ç å®¡æŸ¥
4. æ ‡è®° Story ä¸º review çŠ¶æ€
