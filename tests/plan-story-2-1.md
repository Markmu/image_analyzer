# Story 2-1: 图片上传功能 - 测试计划

## 测试范围

根据 Story 2-1 的 7 个验收标准，设计全面的测试覆盖。

## 验收标准映射

### AC-1: 拖拽/点击上传
**单元测试：**
- [x] ImageUploader 组件渲染正确
- [ ] 拖拽事件处理正确
- [ ] 点击上传区域触发文件选择
- [ ] 文件选择后触发上传

**E2E 测试：**
- [ ] 桌面端拖拽上传完整流程
- [ ] 移动端点击上传完整流程

### AC-2: 格式和大小验证
**单元测试：**
- [ ] 验证 JPEG 格式被接受
- [ ] 验证 PNG 格式被接受
- [ ] 验证 WebP 格式被接受
- [ ] 验证不支持的格式被拒绝（GIF、BMP等）
- [ ] 验证文件大小 ≤ 10MB 被接受
- [ ] 验证文件大小 > 10MB 被拒绝
- [ ] 验证图片尺寸 ≥ 200x200px 被接受
- [ ] 验证图片尺寸 < 200x200px 被拒绝
- [ ] 验证图片尺寸 ≤ 8192x8192px 被接受
- [ ] 验证图片尺寸 > 8192x8192px 被拒绝

**集成测试：**
- [ ] API 路由验证逻辑正确
- [ ] 验证失败返回正确的错误响应

**E2E 测试：**
- [ ] 上传超大文件显示正确错误信息
- [ ] 上传不支持的格式显示正确错误信息

### AC-3: 上传进度显示
**单元测试：**
- [ ] 进度条初始值为 0
- [ ] 上传过程中进度实时更新
- [ ] 上传完成进度为 100
- [ ] 进度条样式正确

**集成测试：**
- [ ] axios progress 回调正常工作
- [ ] 进度状态正确更新

**E2E 测试：**
- [ ] 上传过程中进度条可见且更新
- [ ] 上传完成后显示成功消息

### AC-4: 取消上传
**单元测试：**
- [ ] 取消按钮在上传中显示
- [ ] 点击取消按钮触发 axios cancel
- [ ] 取消后状态重置为 idle
- [ ] 取消后进度重置为 0

**集成测试：**
- [ ] axios CancelToken 正常工作
- [ ] 取消后不调用 onUploadSuccess

**E2E 测试：**
- [ ] 上传过程中可以取消
- [ ] 取消后可以重新上传

### AC-5: 复杂图片检测
**单元测试：**
- [ ] 识别复杂场景（预留接口）
- [ ] 分析置信度 < 50% 时显示警告

**集成测试：**
- [ ] API 返回警告信息正确处理
- [ ] 警告信息正确显示

**E2E 测试：**
- [ ] 复杂图片显示警告提示

### AC-6: 数据库元数据保存
**单元测试：**
- [ ] images 表 schema 正确定义
- [ ] 数据库插入操作正确

**集成测试：**
- [ ] 上传成功后数据库记录创建
- [ ] 数据库插入失败时 R2 文件被清理
- [ ] R2 上传失败时不创建数据库记录

**E2E 测试：**
- [ ] 上传成功后图片数据持久化

### AC-7: 移动端优化
**单元测试：**
- [ ] 触摸目标 ≥ 44x44px
- [ ] 移动端布局正确

**E2E 测试：**
- [ ] 移动端上传体验流畅
- [ ] 移动端显示"拍照"和"相册"选项（如果实现）

---

## 测试文件结构

```
tests/
├── unit/
│   ├── components/
│   │   └── ImageUploader.test.tsx         # 组件单元测试
│   ├── api/
│   │   └── upload-route.test.ts           # API 路由单元测试
│   └── lib/
│       ├── image-validation.test.ts       # 图片验证逻辑测试
│       └── r2-upload.test.ts              # R2 上传测试
├── integration/
│   ├── upload-flow.test.ts                # 上传流程集成测试
│   └── database-cleanup.test.ts           # 数据库清理逻辑测试
└── e2e/
    └── image-upload.spec.ts               # E2E 测试
```

---

## 测试优先级

### P0 - 关键路径（必须通过）
1. AC-1: 基本上传功能（拖拽/点击）
2. AC-2: 格式和大小验证
3. AC-6: 数据库元数据保存

### P1 - 重要功能
4. AC-3: 上传进度显示
5. AC-4: 取消上传
6. AC-7: 移动端优化

### P2 - 增强功能
7. AC-5: 复杂图片检测（预留接口）

---

## Mock 策略

### 单元测试 Mock
- **R2 上传**: Mock `uploadToR2` 函数
- **数据库操作**: Mock `db.insert` 操作
- **文件系统**: Mock `sharp` 图片处理
- **认证**: Mock NextAuth session

### 集成测试 Mock
- **R2 上传**: 使用测试环境或 mock
- **数据库**: 使用测试数据库

### E2E 测试
- **完整环境**: 真实 R2、数据库、认证

---

## 测试数据

### 有效图片
- `test-image-1x1.jpg` - 最小尺寸（用于边界测试）
- `test-image-200x200.png` - 最小允许尺寸
- `test-image-8192x8192.webp` - 最大允许尺寸
- `test-image-5mb.jpg` - 接近大小限制

### 无效图片
- `test-image-100x100.jpg` - 尺寸过小
- `test-image-10000x10000.png` - 尺寸过大
- `test-image-15mb.jpg` - 文件过大
- `test-image.gif` - 不支持的格式

---

## 覆盖率目标

- **单元测试**: ≥ 80%
- **集成测试**: 覆盖所有 API 端点和数据库操作
- **E2E 测试**: 覆盖所有验收标准的关键路径

---

## 测试环境要求

### 环境变量
- `R2_ACCOUNT_ID`
- `R2_ACCESS_KEY_ID`
- `R2_SECRET_ACCESS_KEY`
- `R2_BUCKET_NAME`
- `DATABASE_URL`（测试数据库）

### 依赖
- vitest（单元测试）
- playwright（E2E 测试）
- 测试数据库实例

---

## 测试执行计划

### Phase 1: 单元测试
1. 编写 ImageUploader 组件测试
2. 编写 API 路由验证逻辑测试
3. 编写 R2 上传函数测试
4. 运行测试并修复失败

### Phase 2: 集成测试
1. 编写上传流程集成测试
2. 编写数据库清理逻辑测试
3. 运行测试并修复失败

### Phase 3: E2E 测试
1. 编写拖拽上传 E2E 测试
2. 编写点击上传 E2E 测试
3. 编写错误场景 E2E 测试
4. 运行测试并修复失败

---

## 下一步

1. 创建测试文件结构
2. 编写单元测试（优先 P0）
3. 运行测试验证现有实现
4. 根据测试结果修复问题或补充实现
